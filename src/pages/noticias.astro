---
import Layout from "../layouts/Layout.astro";
import { XMLParser } from "fast-xml-parser";
import Newsletter from "../components/Newsletter.astro";

const RSS_URL =
  "https://teafriendly-blog.blogspot.com/feeds/posts/default?alt=rss";

interface Post {
  title: string;
  link: string;
  description: string;
  pubDate: string;
  thumbnail?: string;
  category?: string | string[];
}

let posts: Post[] = [];
let error = null;

try {
  const response = await fetch(RSS_URL);
  if (!response.ok) throw new Error("Failed to fetch RSS");

  const text = await response.text();
  const parser = new XMLParser({
    ignoreAttributes: false,
    attributeNamePrefix: "@_",
  });
  const feed = parser.parse(text);

  const items = feed.rss?.channel?.item || [];
  const rawPosts = Array.isArray(items) ? items : [items];

  posts = rawPosts.map((item: any) => {
    // Extract thumbnail if available (Blogger often puts it in media:thumbnail or inside description)
    let thumbnail = item["media:thumbnail"]?.["@_url"];

    // If no media:thumbnail, try to find img in description
    if (!thumbnail && item.description) {
      const imgMatch = item.description.match(/<img[^>]+src="([^">]+)"/);
      if (imgMatch) thumbnail = imgMatch[1];
    }

    // Clean description
    let description = item.description
      ? item.description.replace(/<[^>]*>?/gm, "").substring(0, 150) + "..."
      : "";

    // Extract slug from link
    // Example: https://teafriendly-blog.blogspot.com/2023/10/titulo.html -> titulo
    const urlParts = item.link.split("/");
    const filename = urlParts[urlParts.length - 1];
    const slug = filename.replace(".html", "");

    return {
      title: item.title,
      link: item.link,
      slug: slug,
      description: description,
      pubDate: new Date(item.pubDate).toLocaleDateString("es-ES", {
        year: "numeric",
        month: "long",
        day: "numeric",
      }),
      thumbnail: thumbnail,
      category: item.category,
    };
  });
} catch (e) {
  console.error("Error fetching blog posts:", e);
  error =
    "No se pudieron cargar las noticias en este momento. Por favor, visita nuestro blog directamente.";
}
---

<Layout title="Noticias - TEA Friendly Â®">
  <div class="bg-gray-50 min-h-screen py-16 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
      <div class="text-center">
        <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl">
          Noticias y Actualidad
        </h2>
        <p class="mt-3 max-w-2xl mx-auto text-xl text-gray-500 sm:mt-4">
          Mantente al dÃ­a con las Ãºltimas novedades de TEA Friendly Â® y el blog.
        </p>
      </div>

      {
        error && (
          <div class="mt-8 text-center text-red-500">
            <p>{error}</p>
            <a
              href="https://teafriendly-blog.blogspot.com/"
              target="_blank"
              class="mt-4 inline-block text-tea-blue hover:underline"
            >
              Ir al Blog
            </a>
          </div>
        )
      }

      <div
        class="mt-12 grid gap-5 max-w-lg mx-auto lg:grid-cols-3 lg:max-w-none"
      >
        {
          posts.map((post) => (
            <div class="flex flex-col rounded-lg shadow-lg overflow-hidden bg-white hover:shadow-xl transition-shadow duration-300">
              {post.thumbnail ? (
                <div class="flex-shrink-0">
                  <img
                    class="h-48 w-full object-cover"
                    src={post.thumbnail}
                    alt={post.title}
                  />
                </div>
              ) : (
                <div class="flex-shrink-0 h-48 w-full bg-tea-blue/20 flex items-center justify-center">
                  <span class="text-tea-blue text-4xl">ðŸ“°</span>
                </div>
              )}
              <div class="flex-1 p-6 flex flex-col justify-between">
                <div class="flex-1">
                  <p class="text-sm font-medium text-tea-blue">
                    {Array.isArray(post.category)
                      ? post.category[0]
                      : post.category || "Noticias"}
                  </p>
                  <a href={`/noticias/${post.slug}`} class="block mt-2">
                    <p class="text-xl font-semibold text-gray-900">
                      {post.title}
                    </p>
                    <p class="mt-3 text-base text-gray-500">
                      {post.description}
                    </p>
                  </a>
                </div>
                <div class="mt-6 flex items-center">
                  <div class="flex-shrink-0">
                    <span class="sr-only">Fecha</span>
                  </div>
                  <div class="">
                    <p class="text-sm text-gray-500">
                      <time datetime={post.pubDate}>{post.pubDate}</time>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          ))
        }
      </div>

      {
        !error && posts.length === 0 && (
          <div class="text-center mt-10">
            <p class="text-gray-500">
              Cargando noticias o no hay entradas recientes...
            </p>
          </div>
        )
      }
    </div>
  </div>

  <Newsletter />
</Layout>
